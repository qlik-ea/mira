# Mira - A Qlik Associative Engine Discovery Service

**NOTE: This repository is under heavy development**

[![CircleCI](https://circleci.com/gh/qlik-oss/mira.svg?style=shield)](https://circleci.com/gh/qlik-oss/mira) [![Greenkeeper badge](https://badges.greenkeeper.io/qlik-oss/mira.svg)](https://greenkeeper.io/)

## Overview

Mira provides Qlik Associative Engine discovery in a Docker containerized environment. Mira is implemented on Node.js and supports different orchestration platforms such as Docker Swarm and Kubernetes. Mira can also operate in a simpler _DNS_ mode and a _Local_ mode.

The documentation in this repository is primarily intended for contributors to Mira development and for those who want to improve Mira by submitting issues.

For Mira's end-user documentation, see [Qlik Core](https://qlikcore.com/docs/services/mira/) documentation site.

## Contributing

Contributions are welcome and encouraged! See more info at [Open Source at Qlik R&D](https://github.com/qlik-oss/open-source).

## Docker Image

Mira is distributed to end users as a the [qlikcore/mira](https://hub.docker.com/r/qlikcore/mira) Docker image. Also see the [Dockerfile](./Dockerfile). The [version file needs to be generated](#generating-version-file) before building the Docker image locally.

## Running Mira as a Plain Node.js Process

For convenience and development purposes, Mira can be started as a non-Dockerized Node.js process. In this case, Mira would most commonly also be used in _Local_ mode, so the `MIRA_MODE` environment variable should be provided accordingly:

```sh
$ MIRA_MODE=local npm start
```

## Development

### Editor/IDE Configuration

No particular editor or IDE is assumed. The repo root contains an [.editorconfig](./.editorconfig) file for editors that support it. If not, make sure that the used editor is configured accordingly.

### Coding Guidelines

JavaScript code shall be developed according the [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript).

The [eslintrc.json](./eslintrc.json) file incorporates these rules with minor modifications.

### Install Packages

Once the repo has been cloned, in the repo root, run:

```sh
$ npm install
```

If errors on _node-gyp_ are encoutered on Windows it is due to the [C++ compilation step for Dredd](https://dredd.readthedocs.io/en/latest/installation.html#why-i-m-seeing-node-gyp-errors). This can be avoided by instead using precompiled binaries by running:

```sh
$ npm install --no-optional
```

### Generating version file

Mira will in run-time make use of build information e.g. commit SHA and version number.
This information is already present in the Mira Docker image, but if running Mira as a non-dockerized process this file (`version.json`) must also be available locally.
The file can be generated by running the following command:

```bash
./generate_version_file.sh
```

### Generating the OpenAPI Specification

Mira's REST API is specified in the [api-doc.yml](./doc/api-doc.yml) [OpenAPI](https://www.openapis.org/) document. The OpenAPI specification is generated from JSDoc by running:

```sh
$ npm run generate-openapi
```

### Circle CI

Circle CI is configured to build a new Docker image from all pushed commits on all branches of Mira. As part of this, the built Docker image is pushed to Docker Hub. If pushing to a feature branch (different from `master`), the Docker image is tagged with `<version>-<build-number>`, where `<version>` is fetched from [`package.json`](./package.json), and `<build-number>` is the automatically increased Circle CI build number given to each build. If pushing to `master` the image is also tagged with `latest`.

### Testing

Unit and component tests can be run with:

```sh
$ npm run test:unit
$ npm run test:component
```

These tests run Mira in isolation and does not depend on any external components.

Integration tests depend on external components. Before they can run, you must accept the [Qlik Core EULA](https://qlikcore.com/beta/) by setting the `ACCEPT_EULA` environment variable, you start the services by using the [docker-compose.yml](./docker-compose.yml) file:

```sh
$ ACCEPT_EULA=yes docker-compose up -d
$ npm run test:integration
```

To run integration tests towards a specific image tag, provide the `TAG` environment variable to `docker-compose`:

```bash
$ ACCEPT_EULA=yes TAG=:<YOUR TAG HERE> docker-compose up -d
$ npm run test:integration
```

See [package.json](./package.json) for more test script variants.

### Releasing

#### Mira service release

The helper script [release.sh](./release.sh) provides a convenient way to release a new version of the service and to automatically bump versions as needed.

Check usage information in [release.sh](./release.sh) on how to perform the release and version bumping by running:

```
$ release.sh -?
```

##### Helm chart release

Mira provides a set of [Helm](https://docs.helm.sh/) charts that can be used to deploy the service to `Kubernetes`.
If the Helm charts has been updated you will need to create a new package.
This is done by running the following script and checking in the changes:

```sh
./helm/create_package.sh <version number>
```

The script will create a Helm package and add it to the [index](./helm/repo/index.yaml) in the repo.
Once checked into the repo the chart can be added as a dependency to other services.
